# Map directives for {{ item.1 }} ({{ item.0.name }})
# These should be included at http level in /etc/nginx/conf.d/maps-{{ item.0.name }}-{{ item.1 | replace('.', '_') }}.conf

map $http_cookie $has_sticky_cookie_{{ item.1 | replace('.', '_') }} {
    default 0;
    {% for fresh_domain in item.0.fresh_domains %}
    ~sticky_{{ item.0.name }}=([a-zA-Z0-9]{5})_{{ fresh_domain | regex_escape() }}     1;
    {% endfor %}
}

map $http_cookie $sticky_sub_{{ item.1 | replace('.', '_') }} {
    default "";
    ~sticky_{{ item.0.name }}=([a-zA-Z0-9]{5})_.* $1;
}

map $http_cookie $sticky_domain_{{ item.1 | replace('.', '_') }} {
    default "";
    ~sticky_{{ item.0.name }}=[a-zA-Z0-9]{5}_(.*) $1;
}

# Distribute randomly based on last digit
map $msec$remote_port $selected_fresh_{{ item.1 | replace('.', '_') }} {
    {% set fresh_domains = item.0.fresh_domains %}
    {% set domains_count = fresh_domains | length %}
    {% if domains_count > 0 %}
        {% for i in range(domains_count) %}
            {% set start_digit = (i * 10) // domains_count %}
            {% set end_digit = ((i + 1) * 10) // domains_count - 1 %}
            {% if start_digit == end_digit %}
    ~.*{{ start_digit }}$ "{{ fresh_domains[i] }}";
            {% else %}
    ~.*[{{ start_digit }}-{{ end_digit }}]$ "{{ fresh_domains[i] }}";
            {% endif %}
        {% endfor %}
    {% endif %}
    default "{{ fresh_domains[0] if fresh_domains else 'example.com' }}";
}

server {
    listen 80;
    server_name {{ item.1 }};
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name {{ item.1 }};
    
    ssl_certificate /etc/letsencrypt/live/{{ item.1 }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ item.1 }}/privkey.pem;
    
    # SSL configuration
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;

    # Debug headers (remove in production)
    add_header X-Debug-Sub "$sticky_sub_{{ item.1 | replace('.', '_') }}";
    add_header X-Debug-Domain "$sticky_domain_{{ item.1 | replace('.', '_') }}";
    add_header X-Debug-HasSticky "$has_sticky_cookie_{{ item.1 | replace('.', '_') }}";
    
    location / {
        set $temp "${request_id}${msec}${remote_port}";
        set $random_str "";
        set $fallback_str "";
        
        # Primary match
        if ($temp ~ "([0-9a-fA-F])([0-9])([0-9a-fA-F])([0-9])([0-9a-fA-F])") {
            set $random_str "$1$2$3$4$5";
        }
        
        # Fallback match (not nested)
        if ($random_str = "") {
            set $fallback_str "$request_id";
        }
        
        # Extract from fallback if needed
        if ($fallback_str ~ "^([0-9a-f]{2})([0-9a-f]{2})([0-9a-f])") {
            set $random_str "$1$2$3";
        }
        
        # Ultimate fallback
        if ($random_str = "") {
            set $random_str "a1b2c";
        }
        
        # Use sticky cookie if available
        if ($has_sticky_cookie_{{ item.1 | replace('.', '_') }}) {
            return 302 https://$sticky_sub_{{ item.1 | replace('.', '_') }}.$sticky_domain_{{ item.1 | replace('.', '_') }}$request_uri;
        }
        
        # Set cookie and redirect
        add_header Set-Cookie "sticky_{{ item.0.name }}=${random_str}_$selected_fresh_{{ item.1 | replace('.', '_') }}; Path=/; Max-Age=604800; HttpOnly; Secure; SameSite=Lax";
        return 302 https://$random_str.$selected_fresh_{{ item.1 | replace('.', '_') }}$request_uri;
    }
    
    # Health check endpoint
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
    
    error_log /var/log/nginx/{{ item.0.name }}_{{ item.1 | replace('.', '_') }}_error.log;
    access_log /var/log/nginx/{{ item.0.name }}_{{ item.1 | replace('.', '_') }}_access.log;
}